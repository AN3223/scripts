#!/bin/sh
# Requires socat (and optionally requires playerctl if the -p argument is used)

err() { printf 'listenman: %s\n' "$1" >&2; exit 1; }
check() { command -v "$1" > /dev/null || err "$1 must be installed"; }
mpv_send() { printf '%s\n' "$1" | socat - /tmp/listenman; }

help() {
	err 'listenman [OPTIONS] SUBCOMMAND

INFO:
	Similar to playerctl, but works with mpv too. Add 
	input-ipc-server=/tmp/listenman to your ~/.config/mpv/mpv.conf

OPTIONS:
	-p
		Also call playerctl with a matching subcommand
	-h
		Shows this message

SUBCOMMANDS:
	next
	previous
	play-pause
	play
	pause
	stop'
}

while getopts 'ph' o; do
	case "$o" in
		p)     playerctl=1;;
		h | *) help;;
	esac
done
shift $((OPTIND-1))

# Check for dependencies
check socat && [ "$playerctl" ] && check playerctl

touch /tmp/listenman

case "$1" in
	next)       mpv_send '{"command": ["playlist-next"]}';;
	previous)   mpv_send '{"command": ["playlist-prev"]}';;
	play-pause) mpv_send '{"command": ["cycle", "pause"]}';;
	play)       mpv_send '{"command": ["play"]}';;
	pause)      mpv_send '{"command": ["pause"]}';;
	stop)       mpv_send '{"command": ["stop"]}';;
	*)          err      'Invalid subcommand';;
esac

# Implements -p
[ "$playerctl" ] && playerctl -a "$1"

